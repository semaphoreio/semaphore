version: v1.0
name: "ğŸ’ Ruby CI Pipeline"         

# ---------------------------------------------------------------------
# GLOBAL SETTINGS
# ---------------------------------------------------------------------
agent:
  machine:
    type: {{ machine_type }}        # Filled by template variables
    os_image: {{ os_image }}

# Fast feedback & cost control
fail_fast:
  stop:
    when: branch != 'main'          # Abort early on non-main branches
auto_cancel:
  running:
    when: branch != 'main'          # Cancel older runs on feature branches
  queued:
    when: branch = 'main'           # Keep the queue clean for main

# Common pre-steps for every job
global_job_config:
  prologue:
    commands:
      - checkout                        # Grab the code
      - sem-service start postgres 17   # Start Postgres 17
      - sem-service start redis 7       # Start Redis 7
      - sem-version ruby 3.2.2          # Select Ruby 3.2.2
      - sem-version node 20.11.0        # Select Node 20.11
      - cache restore                   # Pull dependencies & packs from cache

# ---------------------------------------------------------------------
# WORKFLOW
# ---------------------------------------------------------------------
blocks:
  # ---------------- SETUP ----------------
  - name: "ğŸ›  Setup & Cache"
    task:
      jobs:
        - name: Install Gems & JS deps
          commands:
            - yarn install --frozen-lockfile                   # Install JS deps
            - bundle install --deployment --path vendor/bundle # Install Ruby gems
            - gem install --no-document semaphore_test_boosters  # Install Boosters gem
            - cache store                                      # Save vendor/bundle & node_modules
    dependencies: []

  # ------------- FRONT-END BUILD -------------
  - name: "ğŸ–¼ï¸ Webpacker Build"
    task:
      jobs:
        - name: Compile Assets
          commands:
            - cache restore webpacker-assets               # Reuse previous packs if present
            - bundle exec rake webpacker:compile           # Produce packs for tests
            - cache store webpacker-assets public/packs    # Save packs for later blocks
    dependencies:
      - "ğŸ›  Setup & Cache"

  # ------------- CODE QUALITY -------------
  - name: "ğŸ” ESLint & Stylelint"
    task:
      jobs:
        - name: JS / CSS Lint
          commands:
            - yarn run eslint .                # Lint JavaScript
            - yarn run stylelint '**/*.scss'   # Lint SCSS
    dependencies:
      - "ğŸ–¼ï¸ Webpacker Build"

  - name: "ğŸ§¹ RuboCop"
    task:
      jobs:
        - name: Ruby Style Check
          commands:
            - bundle exec rubocop             # Enforce Ruby style
    dependencies:
      - "ğŸ›  Setup & Cache"

  # ------------- SECURITY -------------
  - name: "ğŸ›¡ï¸ Brakeman"
    task:
      jobs:
        - name: Static Analysis
          commands:
            - bundle exec brakeman --force    # Rails security scan
    dependencies:
      - "ğŸ›  Setup & Cache"

  - name: "ğŸ›¡ï¸ Bundler Audit"
    task:
      jobs:
        - name: Gem CVE Check
          commands:
            - bundle exec bundle-audit check --update
    dependencies:
      - "ğŸ›  Setup & Cache"

  # ------------- TEST SUITE (Boosters) -------------
  - name: "ğŸš¦ RSpec Suite"
    task:
      env_vars:
        - name: RAILS_ENV
          value: test              # Use the test environment
        - name: PGHOST
          value: 127.0.0.1         # PostgreSQL host
        - name: PGUSER
          value: postgres          # PostgreSQL user
      jobs:
        - name: "ğŸŸ¢ RSpec Tests"
          parallelism: 5                       # Split across 5 nodes
          commands:
            - cache restore webpacker-assets   # Pull precompiled packs
            - bundle exec rake db:setup        # Build fresh test DB
            # Automatic test splitting via Semaphore Boosters
            - rspec_booster --job "$SEMAPHORE_JOB_INDEX/$SEMAPHORE_JOB_COUNT" --format RspecJunitFormatter --out report.xml --format documentation
      epilogue:
        always:
          commands:
            - '[[ -f report.xml ]] && test-results publish report.xml'
    dependencies:
      - "ğŸ§¹ RuboCop"
      - "ğŸ›¡ï¸ Brakeman"
      - "ğŸ›¡ï¸ Bundler Audit"
      - "ğŸ–¼ï¸ Webpacker Build"

# ---------------------------------------------------------------------
# PIPELINE SUMMARY
# ---------------------------------------------------------------------
after_pipeline:
  task:
    jobs:
      - name: "ğŸ“Š Merge Results"
        commands:
          - test-results gen-pipeline-report  # Collate JUnit reports
