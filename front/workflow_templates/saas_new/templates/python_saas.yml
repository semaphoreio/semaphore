version: v1.0  # Pipeline schema: https://docs.semaphoreci.com/reference/pipeline-yaml/
name: "ğŸ Python CI/CD Pipeline"

agent:  # Placeholders; choose real values in UI â†’ https://docs.semaphoreci.com/reference/machine-types/
  machine:
    type: {{ machine_type }}
    os_image: {{ os_image }}

auto_cancel:  # Skip queued runs on new commit â†’ https://docs.semaphoreci.com/reference/pipeline-yaml/#auto-cancel
  queued:
    when: 'true'

fail_fast:  # Abort jobs fast on nonâ€‘main branches â†’ https://docs.semaphoreci.com/reference/pipeline-yaml/#fail-fast
  cancel:
    when: branch != 'main'

global_job_config:
  prologue:  # Commands executed at every job start
    commands:
      - checkout  # Fetch repo at current commit

blocks:
  - name: "ğŸ“¦ Setup Dependencies"
    dependencies: []
    task:
      jobs:
        - name: "ğŸ“¦ Install dependencies"
          commands:
            - echo "Setting up Python environment and caching dependenciesâ€¦"
            - 'export PATH="$HOME/.local/bin:$PATH"'
            - mkdir -p .pip_cache
            - cache restore  # Restore pip cache â†’ https://docs.semaphoreci.com/essentials/caching-dependencies/
            - |
              if [ -f requirements.txt ]; then
                pip install --user --cache-dir .pip_cache -r requirements.txt
              else
                echo "No requirements.txt found, skipping installation."
              fi
            - cache store  # Store updated cache

  - name: "ğŸ” Lint"
    dependencies:
      - "ğŸ“¦ Setup Dependencies"
    task:
      jobs:
        - name: "ğŸ” flake8 lint"
          commands:
            - echo "Running flake8 lintâ€¦"
            - 'export PATH="$HOME/.local/bin:$PATH"'
            - mkdir -p .pip_cache
            - cache restore
            - 'pip install --user flake8 || echo "flake8 not installed, skipping lint."'
            - flake8 . || echo "flake8 found issues."

  - name: "ğŸ§ª Unit Tests"
    dependencies:
      - "ğŸ›¡ï¸Security Checks"  # Tests run only if security passes
    task:
      jobs:
        - name: "ğŸ§ª pytest unit"
          commands:
            - echo "Running unit tests with pytestâ€¦"
            - sem-version python $PYTHON_VERSION  # Interpreter selector â†’ https://docs.semaphoreci.com/essentials/available-languages-tools/#python
            - 'export PATH="$HOME/.local/bin:$PATH"'
            - mkdir -p .pip_cache
            - cache restore
            - 'pytest --maxfail=1 --disable-warnings -q --junitxml=junit_unit.xml tests || echo "No unit tests found, skipping."'
          matrix:  # Matrix build across Python versions â†’ https://docs.semaphoreci.com/reference/pipeline-yaml/#matrix
            - env_var: PYTHON_VERSION
              values:
                - '3.10'
                - '3.11'
                - '3.12'
      epilogue:
        always:
          commands:
            - test-results publish junit_unit.xml || echo "No unit test results to publish."  # Publish reports â†’ https://docs.semaphoreci.com/essentials/test-reports/

  - name: "ğŸ”— Integration Tests"
    dependencies:
      - "ğŸ›¡ï¸Security Checks"
    task:
      jobs:
        - name: "ğŸ”— pytest integration"
          commands:
            - echo "Running integration tests with pytestâ€¦"
            - sem-version python $PYTHON_VERSION
            - 'export PATH="$HOME/.local/bin:$PATH"'
            - mkdir -p .pip_cache
            - cache restore
            - 'pytest --maxfail=1 --disable-warnings -q --junitxml=junit_integration.xml tests/integration || echo "No integration tests found, skipping."'
          matrix:
            - env_var: PYTHON_VERSION
              values:
                - '3.10'
                - '3.11'
                - '3.12'
      epilogue:
        always:
          commands:
            - test-results publish junit_integration.xml || echo "No integration test results to publish."

  - name: "ğŸ³ Docker Build"
    dependencies:
      - "ğŸ”— Integration Tests"
      - "ğŸ§ª Unit Tests"
    task:
      jobs:
        - name: "ğŸ³ Build image"
          commands:
            - echo "Building Docker imageâ€¦"
            - |
              if [ -f Dockerfile ]; then
                docker build -t my-python-app:${SEMAPHORE_GIT_BRANCH:-latest} .
              else
                echo "No Dockerfile found, skipping Docker build."
              fi

  - name: "ğŸ›¡ï¸Security Checks"
    dependencies:
      - "ğŸ“¦ Setup Dependencies"
    task:
      jobs:
        - name: "ğŸ›¡ï¸ Bandit scan"
          commands:
            - echo "Running Bandit security scanâ€¦"
            - 'export PATH="$HOME/.local/bin:$PATH"'
            - mkdir -p .pip_cache
            - cache restore
            - 'pip install --user bandit || echo "bandit not installed, skipping security scan."'
            - bandit -r . -ll || echo "Bandit found security issues."

after_pipeline:
  task:
    jobs:
      - name: "ğŸ“Š Merge reports"
        commands:
          - test-results gen-pipeline-report  # Consolidate all JUnit XMLs
