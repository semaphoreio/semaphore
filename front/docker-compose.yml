version: '3.6'

services:
  app:
    image: ${IMAGE:-front-app}:${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: front/Dockerfile
      target: dev
      args:
        - MIX_ENV=${MIX_ENV:-dev}
      ssh:
        - default
      cache_from:
        - ${MAIN_IMAGE:-front-app}:${IMAGE_TAG:-latest}
    ports:
      - "4000:4000"

    environment:
      CACHE_PREFIX: "front/"
      CACHE_HOST: "redis-cache"
      CACHE_PORT: "6379"
      CACHE_POOL_SIZE: "5"
      AMQP_URL: "amqp://rabbitmq:5672"
      SSH_AUTH_SOCK: /ssh-agent
      MIX_ENV: ${MIX_ENV:-dev}
      SEED_CE_FEATURES: "false"
      SEED_CLOUD_MACHINES: "true"
      SEED_SELF_HOSTED_AGENTS: "true"
      EXCLUDE_STUBS: "InstanceConfigMock"
      WORKFLOW_TEMPLATES_YAMLS_PATH: "/app/workflow_templates/saas"
      SEED_PROJECTS: "initializing_failed,zebra,guard,errored,test_results,test_results_debug,after_pipeline,bitbucket,generic_git"
      SECRET_KEY_BASE: "keyboard-cat-please-use-this-only-for-dev-and-testing-it-is-insecure"
      SESSION_SIGNING_SALT: "keyboard-cat-please-use-this-only-for-dev-and-testing-it-is-insecure"
      INTERNAL_API_URL_ARTIFACTHUB: "127.0.0.1:50052"
      INTERNAL_API_URL_AUDIT: "127.0.0.1:50052"
      INTERNAL_API_URL_AUTHENTICATION: "127.0.0.1:50051"
      INTERNAL_API_URL_BILLING: "127.0.0.1:50052"
      INTERNAL_API_URL_BRANCH: "127.0.0.1:50052"
      INTERNAL_API_URL_DASHBOARDHUB: "127.0.0.1:50052"
      INTERNAL_API_URL_FEATURE: "127.0.0.1:50052"
      INTERNAL_API_URL_GUARD: "127.0.0.1:50052"
      INTERNAL_API_URL_USER: "127.0.0.1:50052"
      INTERNAL_API_URL_HOOKS: "127.0.0.1:50052"
      INTERNAL_API_URL_INSTANCE_CONFIG: "127.0.0.1:50052"
      INTERNAL_API_URL_JOB: "127.0.0.1:50052"
      INTERNAL_API_URL_LOGHUB2: "127.0.0.1:50051"
      INTERNAL_API_URL_NOTIFICATION: "127.0.0.1:50052"
      INTERNAL_API_URL_OKTA: "127.0.0.1:50052"
      INTERNAL_API_URL_ORGANIZATION: "127.0.0.1:50052"
      INTERNAL_API_URL_SCHEDULER: "127.0.0.1:50052"
      INTERNAL_API_URL_PERMISSION_PATROL: "127.0.0.1:50052"
      INTERNAL_API_URL_PLUMBER: "127.0.0.1:50052"
      INTERNAL_API_URL_PFC: "127.0.0.1:50052"
      INTERNAL_API_URL_PROJECT: "127.0.0.1:50052"
      INTERNAL_API_URL_RBAC: "127.0.0.1:50052"
      INTERNAL_API_URL_REPO_PROXY: "127.0.0.1:50051"
      INTERNAL_API_URL_REPOHUB: "127.0.0.1:50052"
      INTERNAL_API_URL_REPOSITORY_INTEGRATOR: "127.0.0.1:50052"
      INTERNAL_API_URL_REPOSITORY: "127.0.0.1:50052"
      INTERNAL_API_URL_SCOUTER: "127.0.0.1:50052"
      INTERNAL_API_URL_SECRETHUB: "127.0.0.1:50052"
      INTERNAL_API_URL_SELFHOSTEDHUB: "127.0.0.1:50052"
      INTERNAL_API_URL_SUPERJERRY: "127.0.0.1:50051"
      INTERNAL_API_URL_TASK: "127.0.0.1:50052"
      INTERNAL_API_URL_VELOCITY: "127.0.0.1:50052"
      INTERNAL_API_URL_LICENSE: "127.0.0.1:50052"
      INTERNAL_API_URL_GOFER: "127.0.0.1:50052"
      INTERNAL_API_URL_GROUPS: "127.0.0.1:50052"
      INTERNAL_API_URL_LOGHUB: "127.0.0.1:50051"
      INTERNAL_API_URL_LICENSE_CHECKER: "127.0.0.1:50052"

    links:
      - redis-cache:redis-cache
      - rabbitmq:rabbitmq
      - artifacts:artifacts

    tty: true
    volumes:
      - .:/app

  redis-cache:
    image: "redis:5-buster"
    entrypoint: "redis-server --appendonly yes"

  artifacts:
    image: "halverneus/static-file-server"
    ports:
      - "9000:8080"
    environment:
      PORT: 8080
      CORS: "true"
      FOLDER: "/var/www"

    volumes:
      - ./priv/storage:/var/www

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbit log_levels [{connection,error}]"
