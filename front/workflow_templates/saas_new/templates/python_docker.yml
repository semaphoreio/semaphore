version: v1.0  # Pipeline schema: https://docs.semaphoreci.com/reference/pipeline-yaml/
name: "ğŸ Python CI/CD Pipeline"

agent:  # Define execution environment; select machine type in UI â†’ https://docs.semaphoreci.com/reference/machine-types/
  machine:
    type: {{ machine_type }}
  containers:
    - name: main
      image: 'registry.semaphoreci.com/python:3.12.1'  # Docker container image â†’ https://docs.semaphoreci.com/ci-cd-environment/docker-images/

auto_cancel:  # Automatically cancel queued runs upon new commits â†’ https://docs.semaphoreci.com/reference/pipeline-yaml/#auto-cancel
  queued:
    when: 'true'

fail_fast:  # Quickly abort non-main branch jobs if failures occur â†’ https://docs.semaphoreci.com/reference/pipeline-yaml/#fail-fast
  cancel:
    when: branch != 'main'

global_job_config:
  prologue:  # Commands run at the start of each job
    commands:
      - checkout  # Check out the current commit â†’ https://docs.semaphoreci.com/essentials/checking-out-code/

blocks:
  - name: "ğŸ“¦ Setup Dependencies"
    dependencies: []
    task:
      jobs:
        - name: "ğŸ“¦ Install dependencies"
          commands:
            - echo "Setting up Python environment and caching dependenciesâ€¦"
            - 'export PATH="$HOME/.local/bin:$PATH"'
            - mkdir -p .pip_cache
            - cache restore  # Restore cached dependencies â†’ https://docs.semaphoreci.com/essentials/caching-dependencies/
            - |
              if [ -f requirements.txt ]; then
                pip install --user --cache-dir .pip_cache -r requirements.txt
              else
                echo "No requirements.txt found, skipping installation."
              fi
            - cache store  # Store dependencies for future runs â†’ https://docs.semaphoreci.com/essentials/caching-dependencies/

  - name: "ğŸ” Lint"
    dependencies:
      - "ğŸ“¦ Setup Dependencies"
    task:
      jobs:
        - name: "ğŸ” flake8 lint"
          commands:
            - echo "Running flake8 lintâ€¦"
            - 'export PATH="$HOME/.local/bin:$PATH"'
            - mkdir -p .pip_cache
            - cache restore
            - 'pip install --user flake8'
            - flake8 .

  - name: "ğŸ›¡ï¸Security Checks"
    dependencies:
      - "ğŸ“¦ Setup Dependencies"
    task:
      jobs:
        - name: "ğŸ›¡ï¸ Bandit scan"
          commands:
            - echo "Running Bandit security scanâ€¦"
            - 'export PATH="$HOME/.local/bin:$PATH"'
            - mkdir -p .pip_cache
            - cache restore
            - 'pip install --user bandit'
            - bandit -r . -ll

  - name: "ğŸ§ª Unit Tests"
    dependencies:
      - "ğŸ›¡ï¸Security Checks"  # Tests run only if security checks pass
    task:
      jobs:
        - name: "ğŸ§ª pytest unit"
          commands:
            - echo "Running unit tests with pytestâ€¦"
            - 'export PATH="$HOME/.local/bin:$PATH"'
            - mkdir -p .pip_cache
            - cache restore
            - 'pytest --maxfail=1 --disable-warnings -q --junitxml=junit_unit.xml tests'
      epilogue:
        always:
          commands:
            - test-results publish junit_unit.xml  # Publish test results â†’ https://docs.semaphoreci.com/essentials/test-reports/

  - name: "ğŸ”— Integration Tests"
    dependencies:
      - "ğŸ›¡ï¸Security Checks"
    task:
      jobs:
        - name: "ğŸ”— pytest integration"
          commands:
            - echo "Running integration tests with pytestâ€¦"
            - 'export PATH="$HOME/.local/bin:$PATH"'
            - mkdir -p .pip_cache
            - cache restore
            - 'pytest --maxfail=1 --disable-warnings -q --junitxml=junit_integration.xml tests/integration'
      epilogue:
        always:
          commands:
            - test-results publish junit_integration.xml  # Publish test results â†’ https://docs.semaphoreci.com/essentials/test-reports/

  - name: "ğŸ³ Docker Build"
    dependencies:
      - "ğŸ”— Integration Tests"
      - "ğŸ§ª Unit Tests"
    task:
      jobs:
        - name: "ğŸ³ Build image"
          commands:
            - echo "Building Docker imageâ€¦"
            - |
              if [ -f Dockerfile ]; then
                docker build -t my-python-app:${SEMAPHORE_GIT_BRANCH:-latest} .
              else
                echo "No Dockerfile found, skipping Docker build."
              fi

after_pipeline:
  task:
    jobs:
      - name: "ğŸ“Š Merge reports"
        commands:
          - test-results gen-pipeline-report  # Consolidate test reports â†’ https://docs.semaphoreci.com/essentials/test-reports/
