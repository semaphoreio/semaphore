version: v1.0  # Pipeline schema: https://docs.semaphoreci.com/reference/pipeline-yaml/
name: "ğŸ”¥ Phoenix CI Pipeline"

# ---------------------------------------------------------------------------
# GLOBAL SETTINGS
# ---------------------------------------------------------------------------

agent:
  machine:
    type: {{ machine_type }}
    os_image: {{ os_image }}
  containers:  # Runtime & sideâ€‘service containers â†’ https://docs.semaphoreci.com/reference/pipeline-yaml/#containers
    - name: main  # Primary job container (Elixir + Node)
      image: 'registry.semaphoreci.com/elixir:1.16'  # Image catalogue â†’ https://docs.semaphoreci.com/using-semaphore/optimization/container-registry#convenience-and-language-images
    - name: postgres  # Postgres DB for tests
      image: 'registry.semaphoreci.com/postgres:17'
      env_vars:
        - name: POSTGRES_PASSWORD
          value: postgres
        - name: POSTGRES_DB
          value: phoenix_test

auto_cancel:
  queued:
    when: 'true'

fail_fast:
  cancel:
    when: branch != 'main'

global_job_config:
  env_vars:
    - name: MIX_ENV
      value: test
  prologue:
    commands:
      - checkout                      # Fetch repo at current commit
      - cache restore                 # Restore cached deps & _build

# ---------------------------------------------------------------------------
# BLOCKS
# ---------------------------------------------------------------------------

blocks:
  # âš™ï¸  Block 1: Install dependencies & compile â€“ caches Hex/Rebar & JS assets
  - name: "âš™ï¸ Install & Compile"
    dependencies: []
    task:
      jobs:
        - name: "âš™ï¸ Install & Compile"
          commands:
            - mix local.hex --force
            - mix local.rebar --force
            - mix deps.get  # Fetch project dependencies
            - mix compile
            - npm install --prefix assets  # Install JS dependencies for Phoenix assets
            - cache store              # Cache deps & build artefacts

  # ğŸ¨  Block 2: Build & digest frontâ€‘end assets
  - name: "ğŸ¨ Assets"
    dependencies: ["âš™ï¸ Install & Compile"]
    task:
      jobs:
        - name: "ğŸ–Œï¸ Compile Assets"
          commands:
            - npm run deploy --prefix assets  # Build production JS/CSS bundle
            - mix phx.digest                  # Generate digested asset fingerprints

  # ğŸ”  Block 3: Static analysis â€“ format, Credo, Dialyzer
  - name: "ğŸ” Static Analysis"
    dependencies: ["âš™ï¸ Install & Compile"]
    task:
      jobs:
        - name: "ğŸ–Œï¸ Format Check"
          commands:
            - mix format --check-formatted
        - name: "ğŸ•µï¸ Credo Lint"
          commands:
            - mix credo --strict
        - name: "ğŸ§  Dialyzer"
          commands:
            - mix dialyzer --halt-exit-status

  # ğŸ›¡ï¸  Block 4: Security scans â€“ dependency & code audits
  - name: "ğŸ›¡ï¸ Security"
    dependencies: ["âš™ï¸ Install & Compile"]
    task:
      jobs:
        - name: "ğŸ›¡ï¸ Sobelow & Audits"
          commands:
            - mix deps.audit                 # Hex deps audit
            - mix sobelow --exit             # Phoenix-specific security scan
            - npm audit --audit-level=moderate --prefix assets

  # ğŸ§ª  Block 5: Tests (unit & integration) â€“ depends only on security
  - name: "ğŸ§ª Tests"
    dependencies: ["ğŸ›¡ï¸ Security"]
    task:
      env_vars:
        - name: DATABASE_URL
          value: "postgres://postgres:postgres@postgres:5432/phoenix_test"  # Host "postgres" resolves to DB sideâ€‘container
      jobs:
        - name: "ğŸ§ª Unit Tests"
          commands:
            - mix deps.get  # Fetch project dependencies
            - mix test --exclude integration --cover --export-coverage unit \
                --formatter ExUnit.CLIFormatter \
                --formatter JUnitFormatter \
                --junit-report-file test_results/unit.xml
            - test-results gen-suite-report  # Publish perâ€‘suite report â†’ https://docs.semaphoreci.com/using-semaphore/tests/test-reports --name "Unit Tests" --format junit --path test_results/unit.xml

        - name: "ğŸ”¬ Integration Tests"
          commands:
            - mix deps.get  # Fetch project dependencies
            - mix test --only integration --cover --export-coverage integration \
                --formatter ExUnit.CLIFormatter \
                --formatter JUnitFormatter \
                --junit-report-file test_results/integration.xml
            - test-results gen-suite-report  # Publish perâ€‘suite report â†’ https://docs.semaphoreci.com/using-semaphore/tests/test-reports --name "Integration Tests" --format junit --path test_results/integration.xml

# ---------------------------------------------------------------------------
# AFTER PIPELINE â€“ coverage & reports
# ---------------------------------------------------------------------------

after_pipeline:
  task:
    secrets:
      - name: coveralls  # COVERALLS_REPO_TOKEN
    jobs:
      - name: "ğŸ“¤ Upload Coverage & Reports"
        commands:
          - mix coveralls.semaphore --exclude integration --import-cover cover  # Upload coverage â†’ https://github.com/parroty/excoveralls
          - test-results gen-pipeline-report    # Aggregate & publish test reports â†’ https://docs.semaphoreci.com/using-semaphore/tests/test-reports
