# This is a Semaphore configuration file for Phoenix projects using Docker
# For more information about Semaphore configuration visit:
# https://docs.semaphoreci.com/reference/pipeline-yaml-reference/

version: v1.0  # Semaphore configuration version
name: "ğŸ”¥ Phoenix CI Pipeline"  # Pipeline display name

# Define the machine type, OS image, and containers
agent:
  machine:
    type: {{ machine_type }}
    os_image: {{ os_image }}

  containers:
    - name: main
      image: 'registry.semaphoreci.com/elixir:1.15'  # Elixir 1.15 container
    - name: postgres
      image: registry.semaphoreci.com/postgres:17  # PostgreSQL 17 for database operations
    - name: redis
      image: registry.semaphoreci.com/redis:7.0  # Redis 7.0 for caching

# Configure when to stop the pipeline early
fail_fast:
  stop:
    when: branch != 'main'  # Stop all blocks if a job fails on non-main branches
auto_cancel:
  running:
    when: branch != 'main'  # Cancel running pipelines on non-main branches
  queued:
    when: branch = 'main'   # Cancel queued pipelines on main branch

# Commands to run before each job
global_job_config:
  prologue:
    commands:
      - checkout                    # Get the code from repository
      - mix local.hex --force      # Install Hex package manager
      - mix local.rebar --force    # Install rebar3 build tool
      - mix deps.get              # Install dependencies
      - cache restore             # Restore cached dependencies

# Pipeline blocks represent groups of jobs that can run in parallel
blocks:
  # Block for setting up dependencies and caching
  - name: "ğŸ› ï¸ Setup and Cache"
    dependencies: []
    task:
      jobs:
        - name: "ğŸ“¦ Install Dependencies"
          commands:
            - mix deps.compile  # Compile dependencies
            - mix compile      # Compile project
            - npm ci --prefix assets  # Install Node.js dependencies
            - cache store      # Cache dependencies for future runs

  # Block for asset compilation
  - name: "ğŸ¨ Assets"
    dependencies: ["ğŸ› ï¸ Setup and Cache"]
    task:
      jobs:
        - name: "ğŸ–Œï¸ Compile Assets"
          commands:
            - npm run deploy --prefix assets  # Build and digest assets
            - mix phx.digest                 # Digest and compress static files

  # Block for code quality checks
  - name: "ğŸ” Code Quality"
    dependencies: ["ğŸ› ï¸ Setup and Cache"]
    task:
      jobs:
        - name: "âœ¨ Lint and Format"
          commands:
            - mix format --check-formatted  # Check code formatting
            - mix credo --strict           # Run static code analysis
            - cd assets && npm run lint    # Check JavaScript code

  # Block for security checks
  - name: "ğŸ” Security Checks"
    dependencies: ["ğŸ› ï¸ Setup and Cache"]
    task:
      jobs:
        - name: "ğŸ›¡ï¸ Security Scan"
          commands:
            - mix deps.audit            # Check Elixir dependencies
            - mix sobelow --config      # Run security-focused static analysis
            - cd assets && npm audit    # Check Node.js dependencies

  # Block for type checking
  - name: "ğŸ“Š Dialyzer"
    dependencies: ["ğŸ› ï¸ Setup and Cache"]
    task:
      jobs:
        - name: "ğŸ” Type Checking"
          commands:
            - mix dialyzer  # Run static type checking

  # Block for running tests
  - name: "ğŸ§ª Test Suite"
    dependencies: ["ğŸ› ï¸ Setup and Cache", "ğŸ¨ Assets"]
    task:
      env_vars:
        - name: MIX_ENV
          value: test
        - name: DATABASE_URL
          value: postgresql://postgres@postgres:5432/app_test  # Use container hostname
        - name: REDIS_URL
          value: redis://redis:6379      # Use container hostname
      jobs:
        - name: "ğŸŸ¢ ExUnit Tests"
          parallelism: 4  # Run tests in parallel
          commands:
            - mix ecto.create     # Create test database
            - mix ecto.migrate    # Run database migrations
            - mix test --cover    # Run tests with coverage

  # Block for browser tests
  - name: "ğŸŒ Browser Tests"
    dependencies: ["ğŸ§ª Test Suite"]
    task:
      jobs:
        - name: "ğŸ­ Wallaby Tests"
          commands:
            - mix wallaby.install  # Install browser testing dependencies
            - mix test --only browser:true  # Run browser tests

  # Block for deployment checks
  - name: "ğŸš€ Deploy Checks"
    dependencies: ["ğŸ§ª Test Suite"]
    task:
      jobs:
        - name: "ğŸ”„ Migration Safety"
          commands:
            - mix ecto.migrations   # Check pending migrations
            - mix phx.routes       # Check route definitions
        - name: "ğŸ“¦ Release Build"
          commands:
            - MIX_ENV=prod mix release --dry-run  # Test release building

  # Block for Docker image
  - name: "ğŸ³ Docker"
    dependencies: ["ğŸš€ Deploy Checks"]
    task:
      secrets:
        - name: dockerhub-credentials
      jobs:
        - name: "ğŸ“¦ Build and Push"
          commands:
            - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
            - docker build -t "${DOCKER_USERNAME}/phoenix-app:${SEMAPHORE_GIT_SHA:0:7}" .
            - docker push "${DOCKER_USERNAME}/phoenix-app:${SEMAPHORE_GIT_SHA:0:7}"
